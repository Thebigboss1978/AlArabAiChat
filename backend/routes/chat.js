import express from "express";

const router = express.Router();

// Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠØ©
const botResponses = {
  // ØªØ­ÙŠØ§Øª
  greetings: [
    "Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! ðŸŒŸ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ù‘Ø§Ø¨",
    "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§Øª! ðŸ›ï¸ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ",
    "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…! ðŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¹ Ø§Ù„Ø¹Ø±Ù‘Ø§Ø¨ Ù„Ù„Ø³ÙŠØ§Ø­Ø©"
  ],
  
  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
  tourInfo: [
    "ðŸšŒ Ù†ÙˆÙØ± Ø¬ÙˆÙ„Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø© Ù„Ù„Ø£Ù‡Ø±Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø´Ù‡ÙŠØ±Ø©",
    "ðŸ“… Ø¬ÙˆÙ„Ø§ØªÙ†Ø§ Ù…ØªØ§Ø­Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 8 ØµØ¨Ø§Ø­Ø§Ù‹ Ø­ØªÙ‰ 6 Ù…Ø³Ø§Ø¡Ù‹",
    "ðŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªØ¨Ø¯Ø£ Ù…Ù† 50 Ø¯ÙˆÙ„Ø§Ø± Ù„Ù„Ø´Ø®Øµ ÙˆØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬ÙˆÙ„Ø©",
    "ðŸ›ï¸ Ù†ØºØ·ÙŠ Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§ØªØŒ Ø£Ø¨Ùˆ Ø§Ù„Ù‡ÙˆÙ„ØŒ Ø§Ù„Ù…ØªØ­Ù Ø§Ù„Ù…ØµØ±ÙŠØŒ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©"
  ],
  
  // Ø­Ø¬Ø² ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„
  booking: [
    "ðŸ“ž Ù„Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±ØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©",
    "ðŸŽ« ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¬Ø² Ø¬ÙˆÙ„ØªÙƒ Ù…Ù‚Ø¯Ù…Ø§Ù‹ Ø£Ùˆ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…",
    "ðŸ’³ Ù†Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹ Ø£Ùˆ Ø¨Ø§Ù„ÙƒØ§Ø±Øª",
    "ðŸš— Ù†ÙˆÙØ± Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª Ø§Ù„Ù…ÙƒÙŠÙØ© Ù…Ù† ÙˆØ¥Ù„Ù‰ Ø§Ù„ÙÙ†Ø¯Ù‚"
  ],
  
  // Ø§ÙØªØ±Ø§Ø¶ÙŠ
  default: [
    "ðŸ¤– Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ ØªÙ…Ø§Ù…Ø§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø¤Ø§Ù„ÙŠ Ø¹Ù†:",
    "ðŸ“‹ - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©\n- Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¬ÙˆÙ„Ø§Øª\n- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø¬Ø²\n- Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­Ø©",
    "ðŸ’¬ Ø£Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ù‘Ø§Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨!"
  ]
};

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø±Ø¯ Ù…Ù†Ø§Ø³Ø¨
function analyzeMessage(message) {
  const text = message.toLowerCase().replace(/[^\w\s\u0600-\u06FF]/g, '');
  
  // ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØ­ÙŠØ©
  if (text.match(/Ø§Ù„Ø³Ù„Ø§Ù…|Ù…Ø±Ø­Ø¨|Ø£Ù‡Ù„|hello|hi|Ø³Ù„Ø§Ù…|ØµØ¨Ø§Ø­|Ù…Ø³Ø§Ø¡/)) {
    return getRandomResponse(botResponses.greetings);
  }
  
  // Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
  if (text.match(/Ø¬ÙˆÙ„Ø©|Ø¬ÙˆÙ„Ø§Øª|Ø±Ø­Ù„Ø©|Ø±Ø­Ù„Ø§Øª|Ø£Ù‡Ø±Ø§Ù…|Ø³ÙŠØ§Ø­Ø©|Ø²ÙŠØ§Ø±Ø©|tour|pyramid/)) {
    return getRandomResponse(botResponses.tourInfo);
  }
  
  // Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±
  if (text.match(/Ø­Ø¬Ø²|Ø³Ø¹Ø±|Ø£Ø³Ø¹Ø§Ø±|ÙƒØ§Ù…|ÙƒÙ„Ù|Ø¯ÙˆÙ„Ø§Ø±|Ø¬Ù†ÙŠÙ‡|book|price|cost|pay/)) {
    return getRandomResponse(botResponses.booking);
  }
  
  // Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØª
  if (text.match(/Ù…ØªÙ‰|ÙˆÙ‚Øª|Ø³Ø§Ø¹Ø©|ÙŠÙˆÙ…|time|when|schedule/)) {
    return "ðŸ• Ø¬ÙˆÙ„Ø§ØªÙ†Ø§ Ù…ØªØ§Ø­Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…Ù† 8:00 Øµ Ø­ØªÙ‰ 6:00 Ù…\nâ° Ù…Ø¯Ø© Ø§Ù„Ø¬ÙˆÙ„Ø© Ù…Ù† 4-8 Ø³Ø§Ø¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±\nðŸ“… ÙŠÙÙØ¶Ù„ Ø§Ù„Ø­Ø¬Ø² Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…ÙƒØ§Ù†";
  }
  
  // Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹
  if (text.match(/ÙÙŠÙ†|ÙˆÙŠÙ†|Ø¹Ù†ÙˆØ§Ù†|Ù…ÙƒØ§Ù†|Ù…ÙˆÙ‚Ø¹|location|where|address/)) {
    return "ðŸ“ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¬Ù…Ø¹: ÙÙ†Ø¯Ù‚Ùƒ Ø£Ùˆ Ø£ÙŠ Ù…ÙƒØ§Ù† ØªØ­Ø¯Ø¯Ù‡ Ø¨Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø£Ùˆ Ø§Ù„Ø¬ÙŠØ²Ø©\nðŸš— Ù†ÙˆÙØ± Ø®Ø¯Ù…Ø© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ Ù…Ù† ÙˆØ¥Ù„Ù‰ Ù…ÙƒØ§Ù† Ø¥Ù‚Ø§Ù…ØªÙƒ\nðŸ—ºï¸ Ø¬ÙˆÙ„Ø§ØªÙ†Ø§ ØªØºØ·ÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©";
  }
  
  // Ø±Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
  return getRandomResponse(botResponses.default);
}

// Ø§Ø®ØªÙŠØ§Ø± Ø±Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
function getRandomResponse(responses) {
  return responses[Math.floor(Math.random() * responses.length)];
}

// POST /api/chat - Chat endpoint
router.post("/", (req, res) => {
  try {
    const { message, user_id } = req.body;
    
    if (!message || message.trim() === '') {
      return res.status(400).json({ 
        error: "âŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø·Ù„ÙˆØ¨Ø©" 
      });
    }

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø±Ø¯ Ù…Ù†Ø§Ø³Ø¨
    const botReply = analyzeMessage(message);
    
    // Ù„ÙˆØ¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„ØªØ·ÙˆÙŠØ±)
    console.log(`ðŸ’¬ [${user_id || 'Anonymous'}]: ${message}`);
    console.log(`ðŸ¤– Bot: ${botReply}`);

    res.json({ 
      success: true,
      message: message,
      reply: botReply,
      timestamp: new Date().toISOString(),
      bot_name: "Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ù‘Ø§Ø¨"
    });

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Chat API:", err.message);
    res.status(500).json({ 
      error: "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…",
      reply: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨."
    });
  }
});

// GET /api/chat/status - Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
router.get("/status", (req, res) => {
  res.json({
    bot_status: "online",
    bot_name: "Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ù‘Ø§Ø¨",
    capabilities: [
      "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª",
      "Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶", 
      "Ø·Ø±Ù‚ Ø§Ù„Ø­Ø¬Ø²",
      "Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­Ø©",
      "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©"
    ],
    last_updated: new Date().toISOString()
  });
});

export default router;
